<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Makeup Try-On</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <!-- MediaPipe FaceMesh and Camera Utils -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <style>
        body {
            text-align: center;
            background-image: url(bg_img.png);
            background-size: cover; 
            background-position: center;
            overflow: hidden;
            font-family: 'Poppins', sans-serif;
        }
        h2{
            color: #ae72cf;
            font-weight: 60px;
            
        }
        canvas {
            display: block; /* Center the canvas */
            margin: auto;
        }
        #closeButton {
            margin: 20px;
            padding: 10px 20px;
            background-color: #f83434; /* Red color */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #closeButton:hover {
            background-color: #ff0000; /* Darker red on hover */
        }
    </style>
</head>
<body>
    <h2>Try Virtual Makeup</h2>
    <!-- Canvas for displaying makeup -->
    <canvas id="outputCanvas" width="640" height="480"></canvas>
    
    <!-- Close Button -->
    <button id="closeButton" onclick="closeWindow()">Close</button>

    <script>
        const selectedLipColor = '#ff0000'; // Default lip color
        let drawLipstick = false; // Flag to control when to draw lipstick

        // Function to start the webcam
        async function startWebcam() {
            const canvasElement = document.getElementById('outputCanvas');
            const canvasCtx = canvasElement.getContext('2d');
            const video = document.createElement('video');
            video.autoplay = true; // Set autoplay
            video.playsinline = true; // For iOS compatibility
            
            // Get webcam stream
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;

            // Initialize FaceMesh model from MediaPipe
            const faceMesh = new FaceMesh({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
            });

            // Configure FaceMesh options
            faceMesh.setOptions({
                maxNumFaces: 1,
                refineLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5,
            });

            // Listen for results from FaceMesh
            faceMesh.onResults(results => {
                // Clear the canvas
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                // Draw the video frame on the canvas
                canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

                const landmarks = results.multiFaceLandmarks[0];
                if (landmarks && drawLipstick) {
                    applyLipstick(landmarks);
                }
            });

            // Function to process video frames
            const sendFrame = async () => {
                await faceMesh.send({ image: video });
                requestAnimationFrame(sendFrame);
            };

            video.addEventListener('loadeddata', sendFrame);
            video.play(); // Play the video immediately
        }

        // Call function to start the webcam immediately
        startWebcam();

        // Show lipstick after 2 seconds
        setTimeout(() => {
            drawLipstick = true; // Set the flag to true after 2 seconds
        }, 2000);

        // Function to apply lipstick to the upper and lower lips
        function applyLipstick(landmarks) {
            const upperLipTop = [61, 185, 40, 39, 37, 0, 267, 269, 270, 409, 291];
            const upperLipBottom = [61, 146, 91, 181, 84, 17, 314, 405, 321, 375];
            const lowerLipTop = [146, 91, 181, 84, 17, 314, 405, 321, 375];
            const lowerLipBottom = [146, 91, 181, 84, 17, 314, 405, 321, 308];

            drawLip(upperLipTop, upperLipBottom, landmarks, 'upper');
            drawLip(lowerLipTop, lowerLipBottom, landmarks, 'lower');
        }

        // Function to draw the upper or lower lip
        function drawLip(outerLip, innerLip, landmarks, lipPart) {
            const canvasCtx = document.getElementById('outputCanvas').getContext('2d');
            canvasCtx.beginPath();
            
            outerLip.forEach((index, i) => {
                const point = landmarks[index];
                const x = point.x * canvasCtx.canvas.width;
                const y = point.y * canvasCtx.canvas.height;
                if (i === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }
            });

            innerLip.reverse().forEach((index, i) => {
                const point = landmarks[index];
                const x = point.x * canvasCtx.canvas.width;
                const y = point.y * canvasCtx.canvas.height;
                if (lipPart === 'lower' && i === 0) {
                    canvasCtx.moveTo(x, y); // Avoid connecting to upper lip
                } else {
                    canvasCtx.lineTo(x, y);
                }
            });

            canvasCtx.closePath();
            canvasCtx.fillStyle = selectedLipColor + 'AA';  // Add transparency
            canvasCtx.fill();
        }

        // Function to close the window
        function closeWindow() {
            window.close();
        }
    </script>
</body>
</html>
